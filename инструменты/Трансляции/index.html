<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="manifest" href="/manifest.webmanifest">
    <title>Трансляции и запись | сайт scratch_craft_2</title>
    <link rel="shortcut icon" href="https://scratch-craft-2.github.io/files/img/favicon.png" type="image/png">
    <link rel="icon" href="/files/img/favicon.png" type="image/png">
    <link id="theme-style" rel="stylesheet" href="/files/css/mainStyle.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap">
    <meta property="og:title" content="Запись экрана и трансляции">
    <meta property="og:site_name" content="сайт scratch_craft_2">
    <meta property="og:url" content="https://scratch-craft-2.github.io/">
    <meta property="og:description" content="сайт скретчера scratch_craft_2 - Запись экрана">
    <meta property="og:image" content="https://scratch-craft-2.github.io/files/img/favicon.png">
    <meta name="description" content="сайт scratch_craft_2 - музыка для проектов, туториалы по скретчу и многое другое!"/>
    <style>
        #controls {
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 999;
        }
        .recording-info {
            margin-bottom: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress {
            height: 100%;
            background: green;
            width: 0;
            transition: width 0.2s;
        }
        .preview {
            width: 300px;
            height: 200px;
            margin: 20px;
        }
        button {
            margin: 5px;
            padding: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<header>  <div class="nav"> <a href="/" style=" text-decoration:none;
    color: #fff !important;
"><b style="
    font-size: 32px;
    padding: 5px;
    margin: 15px;
">Сайт scratch_craft_2</b></a>
    </div>
    </div>
</header>
 <div id="controls">
        <div class="recording-info">
            <span id="timer">00:00</span>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>
        <button id="start">Начать запись</button>
        <button id="stop" disabled>Остановить запись</button>
        <div class="preview">
            <video id="preview" autoplay playsinline></video>
        </div>
    </div>
<script>
let mediaRecorder;
let chunks = [];
let recordingStartTime;
let timerInterval;
let progressBar = document.querySelector('.progress');

// Получение разрешений
async function getMedia() {
    try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: 'always' },
            audio: true
        });
        
        const micStream = await navigator.mediaDevices.getUserMedia({
            audio: true
        });

        // Объединение потоков
        const finalStream = new MediaStream(
            ...stream.getTracks(),
            ...micStream.getTracks()
        );

        // Добавление предварительного просмотра
        const preview = document.getElementById('preview');
        preview.srcObject = finalStream;

        mediaRecorder = new MediaRecorder(finalStream);
        mediaRecorder.ondataavailable = handleDataAvailable;
        mediaRecorder.onstop = handleStop;
        mediaRecorder.onerror = handleError;
    } catch (error) {
        console.error('Ошибка получения медиа:', error);
        alert('Не удалось получить доступ к экрану или микрофону');
    }
}

// Обработка фрагментов
function handleDataAvailable(event) {
    if (event.data.size > 0) {
        chunks.push(event.data);
        updateProgressBar();
    }
}

// Сохранение записи
function handleStop(event) {
    clearInterval(timerInterval);
    const blob = new Blob(chunks, { type: 'video/mp4' });
    chunks = [];
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `запись-экрана-${new Date().toISOString().replace(/[:.-]/g, '')}.mp4`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    resetUI();
}

// Обработка ошибок
function handleError(error) {
    console.error('Произошла ошибка записи:', error);
    alert('Ошибка при записи экрана: ' + error.name);
    resetUI();
}

// Обновление таймера
function updateTimer() {
    const currentTime = new Date().getTime() - recordingStartTime;
    const minutes = Math.floor((currentTime % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((currentTime % (1000 * 60)) / 1000);
    const timerDisplay = document.getElementById('timer');
    
    timerDisplay.textContent = 
        (minutes < 10 ? '0' + minutes : minutes) + 
        ':' + 
        (seconds < 10 ? '0' + seconds : seconds);
}

// Обновление прогресс-бара
function updateProgressBar() {
    const totalSize = chunks.reduce((acc, chunk) => acc + chunk.size, 0);
    const progress = (totalSize / (1024 * 1024)) * 100; // в МБ
    progressBar.style.width = Math.min(progress, 100) + '%';
}

// Сброс интерфейса
function resetUI() {
    document.getElementById('start').disabled = false;
    document.getElementById('stop').disabled = true;
    document.getElementById('timer').textContent = '00:00';
    progressBar.style.width = '0%';
    clearInterval(timerInterval);
    
    const preview = document.getElementById('preview');
    if (preview.srcObject) {
        preview.srcObject.getTracks().forEach(track => track.stop());
        preview.srcObject = null;
    }
}

// Управление записью
document.getElementById('start').addEventListener('click', async () => {
    try {
        await getMedia();
        mediaRecorder.start();
        
        recordingStartTime = new Date().getTime();
        timerInterval = setInterval(updateTimer, 1000);
        
        document.getElementById('start').disabled = true;
        document.getElementById('stop').disabled = false;
    } catch (error) {
        handleError(error);
    }
});

document.getElementById('stop').addEventListener('click', () => {
    mediaRecorder.stop();
});

// Обработка сочетания клавиш для удобства
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            document.getElementById('stop').click();
        }
    }
});
</script>
</body>
</html>
